# Base stage for dependencies
FROM node:22-alpine AS deps
WORKDIR /app

RUN echo "ğŸš€ Starting dependency installation stage..."

# Copy package files for dependency installation
COPY package.json package-lock.json* ./
RUN echo "ğŸ“„ Package files copied successfully!"

# Install dependencies
RUN npm ci --legacy-peer-deps && echo "ğŸ“¦ Dependencies installed successfully!"

# Builder stage
FROM node:22-alpine AS builder
WORKDIR /app

RUN echo "ğŸ—ï¸ Starting builder stage..."

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/package.json /app/package-lock.json* ./
RUN echo "ğŸ“¦ Dependencies copied from previous stage!"

# Copy source code and prisma files
COPY . .
RUN echo "ğŸ“‚ Source code and configuration files copied!"

RUN npm run build && echo "ğŸ‰ Application built successfully!"

# Development stage
FROM builder AS development

RUN echo "ğŸ”§ Setting up development environment..."

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/package.json /app/package-lock.json* ./
RUN echo "ğŸ“š Development dependencies copied!"

# Copy built application and configuration
COPY --from=builder /app/dist ./dist
RUN echo "ğŸ“ Development configuration applied!"

# Setup entrypoint
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh && echo "ğŸ”‘ Entrypoint script prepared!"

# Configure runtime
ENV PORT=${PORT}
EXPOSE $PORT

# Use entrypoint script
ENTRYPOINT ["/app/entrypoint.sh"]

# Production stage
FROM node:22-alpine AS production
WORKDIR /app

RUN echo "ğŸš€ Preparing production environment..."

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/package.json /app/package-lock.json* ./
RUN echo "ğŸ“¦ Production dependencies copied!"

# Copy built application and configuration
COPY --from=builder /app/dist ./dist
RUN echo "âš™ï¸ Production configuration applied!"

# Setup entrypoint
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh && echo "ğŸ”‘ Entrypoint script configured!"

# Configure runtime
ENV PORT=${PORT}
EXPOSE $PORT

# Use entrypoint script
ENTRYPOINT ["/app/entrypoint.sh"]